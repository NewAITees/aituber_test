# AITuber開発ガイド

このドキュメントは、AITuberシステムの開発に関する詳細なガイドラインを提供します。

## 開発環境のセットアップ

### 1. Python環境のセットアップ

```bash
# uvのインストール（既にインストール済みの場合はスキップ）
curl -LsSf https://astral.sh/uv/install.sh | sh

# 依存関係のインストール（開発用ツールも含む）
uv sync --all-extras --dev

# 開発用ツールのセットアップ
uv run pre-commit install
```

### 2. 開発ツールのセットアップ

```bash
# コードフォーマットとリンターの実行
uv run ruff format .
uv run ruff check --fix .

# 型チェックの実行
uv run mypy src/

# テストの実行
uv run pytest tests/
```

## 依存パッケージの管理

このプロジェクトでは`uv`パッケージマネージャーを使用しています。依存関係は`pyproject.toml`で管理され、`uv.lock`ファイルでバージョンが固定されています。

### 新しい依存関係の追加

```bash
# 本番依存関係の追加
uv add パッケージ名

# 開発依存関係の追加
uv add --dev パッケージ名

# 特定バージョンの指定
uv add パッケージ名==バージョン
```

### 依存関係の更新

```bash
# 全依存関係の更新
uv lock --upgrade

# 特定パッケージの更新
uv lock --upgrade-package パッケージ名
```

## アーキテクチャ

### システム構成

```
[視聴者コメント] → [コメント取得] → [ローカルLLM] → [応答生成] → [ローカルTTS] → [音声出力] → [アバター制御] → [OBS] → [配信]
```

### 主要コンポーネント

1. **LLMシステム** (`src/llm/`)
   - Ollamaを使用したローカルLLM実行
   - プロンプトエンジニアリング
   - 応答生成の最適化

2. **音声合成システム** (`src/tts/`)
   - VOICEVOX API連携
   - 音声クローニング（RVC）
   - バイノーラル処理

3. **アバター制御システム** (`src/avatar/`)
   - VRMモデルの制御
   - リップシンク
   - 表情制御

4. **配信システム** (`src/stream/`)
   - YouTube/Twitch連携
   - チャット取得
   - OBS統合

## 開発フロー

### 1. 新機能の追加

1. 機能の要件定義
2. テストケースの作成
3. 実装
4. テスト実行
5. コードレビュー
6. マージ

### 2. テスト

```bash
# ユニットテストの実行
uv run pytest tests/

# カバレッジレポートの生成
uv run pytest --cov=src --cov-report=term-missing tests/

# 特定のテストファイルの実行
uv run pytest tests/test_llm.py

# 特定のテストクラスの実行
uv run pytest tests/test_llm.py::TestLocalLLM
```

### 3. コード品質チェック

```bash
# コードフォーマット
uv run ruff format .

# リンター実行
uv run ruff check --fix .

# 型チェック
uv run mypy src/

# セキュリティチェック
uv run bandit -r src/

# 依存関係の脆弱性チェック
uv run safety check
```

### 4. デプロイ

1. バージョン管理
2. 依存関係の更新
3. テストの実行
4. デプロイスクリプトの実行

## パフォーマンス最適化

### 1. LLM最適化

- 量子化の活用
- バッチ処理の実装
- キャッシュの活用

### 2. 音声処理最適化

- 非同期処理の実装
- バッファサイズの最適化
- GPUアクセラレーション

### 3. アバター最適化

- メッシュの最適化
- アニメーションの効率化
- リソース使用量の監視

## トラブルシューティング

### 1. 一般的な問題

- メモリ使用量の監視
- GPU使用率の確認
- ログの確認

### 2. コンポーネント別の問題

#### LLM
- モデルのロードエラー
- 推論速度の低下
- メモリリーク

#### 音声合成
- 音声品質の問題
- 遅延の発生
- API接続エラー

#### アバター
- モデルの読み込みエラー
- アニメーションの不具合
- パフォーマンスの低下

## セキュリティガイドライン

1. APIキーの管理
2. 環境変数の使用
3. アクセス制御の実装
4. ログの適切な管理

## メンテナンス

### 1. 定期的なメンテナンス

- 依存関係の更新
- ログのローテーション
- バックアップの作成

### 2. モニタリング

- システムリソースの監視
- エラーログの確認
- パフォーマンスメトリクスの収集

## 参考資料

- [技術ドキュメント](../technical_document.md)
- [CLAUDE.md](../CLAUDE.md)
- [API仕様書](./api.md)
- [トラブルシューティングガイド](./troubleshooting.md)
